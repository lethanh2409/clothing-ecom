// prisma/schema.prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // ‚úÖ Th√™m d√≤ng n√†y ƒë·ªÉ ch·ªâ ƒë·ªãnh schema
  schemas  = ["clothing_ecom"]
}

generator client {
  provider = "prisma-client-js"
}

model roles {
  role_id     Int     @id @default(autoincrement())
  role_name   String  @unique
  description String?
  status      Boolean @default(true)

  user_role user_role[]

  @@map("roles")
  @@schema("clothing_ecom") // ‚úÖ Th√™m v√†o m·ªçi model
}

model users {
  user_id       Int       @id @default(autoincrement())
  username      String    @unique
  password      String
  email         String    @unique
  phone         String?
  full_name     String
  status        Boolean   @default(true)
  refresh_token String?
  expired_at    DateTime?
  created_at    DateTime  @default(now()) @db.Timestamp(0)
  updated_at    DateTime  @updatedAt @db.Timestamp(0)

  user_role                     user_role[]
  customers                     customers?
  order_status_history          order_status_history[]
  audit_logs                    audit_logs[]
  site_contents                 site_contents[]                 @relation("UserUpdatedContents")
  product_variant_price_history product_variant_price_history[]

  @@map("users")
  @@schema("clothing_ecom") // ‚úÖ Th√™m v√†o m·ªçi model
}

// ‚úÖ Th√™m @@schema("clothing_ecom") v√†o T·∫§T C·∫¢ c√°c model c√≤n l·∫°i...
model user_role {
  user_role_id Int @id @default(autoincrement())
  user_id      Int
  role_id      Int

  users users @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  roles roles @relation(fields: [role_id], references: [role_id], onDelete: Cascade)

  @@unique([user_id, role_id])
  @@map("user_role")
  @@schema("clothing_ecom")
}

model customers {
  customer_id Int       @id @default(autoincrement())
  user_id     Int       @unique
  birthday    DateTime?
  gender      String?
  created_at  DateTime  @default(now()) @db.Timestamp(0)
  updated_at  DateTime  @updatedAt @db.Timestamp(0)

  users     users       @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  addresses addresses[]
  cart      cart?
  orders    orders[]
  reviews   reviews[]
  returns   returns[]

  @@map("customers")
  @@schema("clothing_ecom")
}

/// ADDRESSES
model addresses {
  address_id      Int      @id @default(autoincrement())
  customer_id     Int
  consignee_name  String
  consignee_phone String
  province        String
  district        String
  ward            String
  street          String   @default("")
  house_num       String   @default("")
  is_default      Boolean  @default(false)
  status          Boolean  @default(true)
  created_at      DateTime @default(now()) @db.Timestamp(0)
  updated_at      DateTime @updatedAt @db.Timestamp(0)

  customers customers @relation(fields: [customer_id], references: [customer_id])
  orders    orders[]

  @@index([customer_id])
  @@schema("clothing_ecom")
}

/// BRANDS
model brands {
  brand_id    Int      @id @default(autoincrement())
  brand_name  String   @unique
  status      Boolean  @default(true)
  slug        String  @unique
  description String
  logo_url    String?
  created_at  DateTime @default(now()) @db.Timestamp(0)
  updated_at  DateTime @updatedAt @db.Timestamp(0)

  products products[]
  sizes    sizes[]

  @@map("brands")
  @@schema("clothing_ecom")
}

/// CATEGORIES
model categories {
  category_id   Int     @id @default(autoincrement())
  category_name String
  parent_id     Int?
  status        Boolean @default(true)

  slug        String  @unique
  description String
  created_at  DateTime @default(now()) @db.Timestamp(0)
  updated_at  DateTime @updatedAt @db.Timestamp(0)

  products products[]

  parent   categories?  @relation("CategoryParent", fields: [parent_id], references: [category_id])
  children categories[] @relation("CategoryParent")

  @@map("categories")
  @@schema("clothing_ecom")
}


/// SIZES
model sizes {
  size_id      Int      @id @default(autoincrement())
  brand_id     Int
  gender       String
  size_label   String
  height_range String
  weight_range String
  measurements Json
  type         String
  created_at   DateTime @default(now()) @db.Timestamp(0)
  updated_at   DateTime @updatedAt @db.Timestamp(0)

  brands           brands            @relation(fields: [brand_id], references: [brand_id])
  product_variants product_variants[]

  @@unique([brand_id, gender, size_label, type])
  @@map("sizes")
  @@schema("clothing_ecom")
}

/// LOOKBOOKS
model lookbooks {
  lookbook_id Int     @id @default(autoincrement())
  title       String
  slug        String  @unique
  description String
  image       String?
  status      String    @default("ACTIVE")
  created_at  DateTime @default(now()) @db.Timestamp(0)
  updated_at  DateTime @updatedAt @db.Timestamp(0)

  lookbook_items lookbook_items[]

  @@map("lookbooks")
  @@schema("clothing_ecom")
}

/// PRODUCTS
model products {
  product_id   Int      @id @default(autoincrement())
  brand_id     Int
  category_id  Int
  product_name String
  slug         String  @unique
  description  String
  status       String   @default("ACTIVE")
  created_at   DateTime @default(now()) @db.Timestamp(0)
  updated_at   DateTime @updatedAt @db.Timestamp(0)

  brands           brands             @relation(fields: [brand_id], references: [brand_id])
  categories       categories         @relation(fields: [category_id], references: [category_id])
  product_variants product_variants[]

  @@map("products")
  @@schema("clothing_ecom")
  lookbookItems lookbook_items[]
}


/// LOOKBOOK_ITEMS
model lookbook_items {
  item_id     Int     @id @default(autoincrement())
  lookbook_id Int
  product_id  Int
  position    Int?
  note        String?

  lookbooks        lookbooks        @relation(fields: [lookbook_id], references: [lookbook_id], onDelete: Cascade)
  products products @relation(fields: [product_id], references: [product_id], onDelete: Cascade)

  @@unique([lookbook_id, product_id])
  @@map("lookbook_items")
  @@schema("clothing_ecom")
}

// C·∫≠p nh·∫≠t model product_variants - th√™m relation
model product_variants {
  variant_id Int      @id @default(autoincrement())
  product_id Int
  size_id    Int
  sku        String   @unique
  barcode    String
  base_price Decimal  @db.Decimal(12, 2)
  quantity   Int      @default(0)
  status     Boolean  @default(true)
  attribute  Json
  created_at DateTime @default(now()) @db.Timestamp(0)
  updated_at DateTime @updatedAt @db.Timestamp(0)

  products                      products                        @relation(fields: [product_id], references: [product_id], onDelete: Cascade)
  sizes                         sizes                           @relation(fields: [size_id], references: [size_id])
  variant_assets                variant_assets[]
  order_detail                  order_detail[]
  inventory_transactions        inventory_transactions[]
  inventory_snapshots           inventory_snapshots[]           // ‚úÖ Th√™m relation
  return_detail                 return_detail[]
  cart_detail                   cart_detail[]
  product_variant_price_history product_variant_price_history[]

  @@map("product_variants")
  @@schema("clothing_ecom")
}

model product_variant_price_history {
  id         Int      @id @default(autoincrement())
  variant_id Int
  old_price  Decimal @db.Decimal(12, 2)
  new_price  Decimal @db.Decimal(12, 2)
  changed_by Int // users.user_id (n·∫øu c√≥)
  reason     String  @db.VarChar(255)
  changed_at DateTime @default(now()) @db.Timestamp(0)

  variant product_variants @relation(fields: [variant_id], references: [variant_id], onDelete: Cascade)
  user    users?           @relation(fields: [changed_by], references: [user_id])

  @@index([variant_id])
  @@index([changed_by])
  @@map("product_variant_price_history")
  @@schema("clothing_ecom")
}

/// VARIANT_ASSETS
model variant_assets {
  asset_id   Int     @id @default(autoincrement())
  variant_id Int
  url        String?
  type       String?
  is_primary Boolean @default(false)

  product_variants product_variants @relation(fields: [variant_id], references: [variant_id], onDelete: Cascade)

  @@unique([variant_id, url])
  @@map("variant_assets")
  @@schema("clothing_ecom")
}

/// INVENTORY_SNAPSHOTS - L∆∞u t·ªìn kho theo th·ªùi gian
model inventory_snapshots {
  snapshot_id Int      @id @default(autoincrement())
  variant_id  Int
  quantity    Int
  snapshot_date DateTime @db.Date
  created_at  DateTime @default(now()) @db.Timestamp(0)

  product_variants product_variants @relation(fields: [variant_id], references: [variant_id], onDelete: Cascade)

  @@unique([variant_id, snapshot_date])
  @@index([variant_id])
  @@index([snapshot_date])
  @@map("inventory_snapshots")
  @@schema("clothing_ecom")
}

/// VOUCHERS
model vouchers {
  voucher_id         Int       @id @default(autoincrement())
  title              String
  description        String?
  discount_type      String
  discount_value     Decimal   @db.Decimal(12, 2)
  min_order_value    Decimal   @db.Decimal(12, 2)
  max_discount       Decimal   @db.Decimal(12, 2)
  quantity           Int       @default(0)
  used_count         Int       @default(0)
  per_customer_limit Int       @default(1)
  start_date         DateTime?
  end_date           DateTime?
  status             Boolean   @default(true)
  created_at         DateTime  @default(now()) @db.Timestamp(0)
  updated_at         DateTime  @updatedAt @db.Timestamp(0)

  orders orders[]

  @@map("vouchers")
  @@schema("clothing_ecom")
}

/// CART
model cart {
  cart_id     Int      @id @default(autoincrement())
  customer_id Int      @unique
  session_id  String?
  updated_at  DateTime @default(now())
  total_price Decimal  @db.Decimal(12, 2) @default(0)

  customers   customers     @relation(fields: [customer_id], references: [customer_id])
  cart_detail cart_detail[]

  @@map("cart")
  @@schema("clothing_ecom")
}

/// CART_DETAIL
model cart_detail {
  cart_detail_id Int     @id @default(autoincrement())
  cart_id        Int
  variant_id     Int
  sub_price      Decimal @db.Decimal(12, 2)
  quantity       Int

  cart             cart             @relation(fields: [cart_id], references: [cart_id], onDelete: Cascade)
  product_variants product_variants @relation(fields: [variant_id], references: [variant_id])

  @@unique([cart_id, variant_id])
  @@map("cart_detail")
  @@schema("clothing_ecom")
}

// C·∫≠p nh·∫≠t model orders - th√™m subtotal_price v√† discount_price
model orders {
  order_id       Int      @id @default(autoincrement())
  customer_id    Int?
  address_id     Int?
  subtotal_price Decimal  @db.Decimal(12, 2)  // T·ªïng ti·ªÅn tr∆∞·ªõc gi·∫£m gi√°
  discount_price Decimal  @db.Decimal(12, 2)  @default(0) // S·ªë ti·ªÅn ƒë∆∞·ª£c gi·∫£m
  total_price    Decimal  @db.Decimal(12, 2)  // T·ªïng ti·ªÅn sau gi·∫£m gi√°
  shipping_fee   Decimal  @db.Decimal(12, 2)  @default(0)
  note           String?
  payment_status String   @default("pending")
  order_status   String   @default("pending")
  created_at     DateTime @default(now()) @db.Timestamp(0)
  updated_at     DateTime @updatedAt @db.Timestamp(0)
  voucher_id     Int?

  customers              customers?               @relation(fields: [customer_id], references: [customer_id])
  addresses              addresses?               @relation(fields: [address_id], references: [address_id])
  vouchers               vouchers?                @relation(fields: [voucher_id], references: [voucher_id])
  order_detail           order_detail[]
  order_status_history   order_status_history[]
  payments               payments[]
  inventory_transactions inventory_transactions[]

  @@map("orders")
  @@schema("clothing_ecom")
}

/// ORDER_STATUS_HISTORY
model order_status_history {
  order_update_id Int      @id @default(autoincrement())
  order_id        Int
  user_id         Int?
  status          String
  created_at      DateTime @default(now()) @db.Timestamp(0)
  orders          orders   @relation(fields: [order_id], references: [order_id], onDelete: Cascade)
  users           users?   @relation(fields: [user_id], references: [user_id])

  @@map("order_status_history")
  @@schema("clothing_ecom")
}

/// ORDER_DETAIL
model order_detail {
  order_detail_id Int     @id @default(autoincrement())
  order_id        Int
  variant_id      Int
  quantity        Int
  total_price     Decimal @db.Decimal(12, 2)

  orders           orders           @relation(fields: [order_id], references: [order_id], onDelete: Cascade)
  product_variants product_variants @relation(fields: [variant_id], references: [variant_id])
  reviews          reviews[]
  return_detail    return_detail[]

  @@map("order_detail")
  @@schema("clothing_ecom")
}

/// PAYMENTS
model payments {
  payment_id     Int      @id @default(autoincrement())
  order_id       Int
  method         String?
  status         String?
  transaction_id String?
  amount         Decimal  @db.Decimal(12, 2)
  raw_response   Json?
  created_at     DateTime @default(now()) @db.Timestamp(0)
  updated_at     DateTime @updatedAt @db.Timestamp(0)

  orders orders @relation(fields: [order_id], references: [order_id], onDelete: Cascade)

  @@map("payments")
  @@schema("clothing_ecom")
}

/// INVENTORY_TRANSACTIONS
model inventory_transactions {
  inventory_id    Int      @id @default(autoincrement())
  variant_id      Int
  change_quantity Int
  reason          String?
  order_id        Int?
  created_at      DateTime @default(now()) @db.Timestamp(0)

  // Quan h·ªá v·ªõi c√°c b·∫£ng kh√°c
  product_variants product_variants @relation(fields: [variant_id], references: [variant_id])
  orders           orders?          @relation(fields: [order_id], references: [order_id])

  @@map("inventory_transactions")
  @@schema("clothing_ecom")
}

/// RETURNS
model returns {
  return_id     Int      @id @default(autoincrement())
  return_type   String
  customer_id   Int? // üëà link v·ªõi customers
  reason        String?
  status        String   @default("requested")
  image         String?
  refund_amount Decimal  @db.Decimal(12, 2) @default(0)
  created_at    DateTime @default(now()) @db.Timestamp(0)
  updated_at    DateTime @updatedAt @db.Timestamp(0)

  customers     customers?      @relation(fields: [customer_id], references: [customer_id])
  return_detail return_detail[]

  @@map("returns")
  @@schema("clothing_ecom")
}

/// RETURN_DETAIL
model return_detail {
  return_detail_id Int  @id @default(autoincrement())
  return_id        Int
  order_detail_id  Int
  new_variant_id   Int?
  quantity         Int

  returns          returns           @relation(fields: [return_id], references: [return_id], onDelete: Cascade)
  order_detail     order_detail      @relation(fields: [order_detail_id], references: [order_detail_id])
  product_variants product_variants? @relation(fields: [new_variant_id], references: [variant_id])

  @@map("return_detail")
  @@schema("clothing_ecom")
}

/// REVIEWS
model reviews {
  review_id       Int      @id @default(autoincrement())
  customer_id     Int
  order_detail_id Int
  rating          Int
  comment         String?
  image           String?
  created_at      DateTime @default(now()) @db.Timestamp(0)
  updated_at      DateTime @updatedAt @db.Timestamp(0)
  status          Boolean  @default(true)

  customers    customers    @relation(fields: [customer_id], references: [customer_id])
  order_detail order_detail @relation(fields: [order_detail_id], references: [order_detail_id])

  @@map("reviews")
  @@schema("clothing_ecom")
}

model audit_logs {
  audit_id    Int      @id @default(autoincrement())
  user_id     Int?
  action      String
  entity_type String?
  entity_id   Int?
  details     Json?
  ip_address  String?
  user_agent  String?
  created_at  DateTime @default(now()) @db.Timestamp(0)

  users users? @relation(fields: [user_id], references: [user_id])

  @@map("audit_logs")
  @@schema("clothing_ecom")
}

/// OTP_CODES
model email_otps {
  id          Int       @id @default(autoincrement())
  email       String
  purpose     String // 'register' | 'reset' ... tu·ª≥ b·∫°n
  code_hash   String
  expires_at  DateTime
  consumed_at DateTime?
  attempts    Int       @default(0)
  sent_count  Int       @default(0)
  created_at  DateTime  @default(now()) @db.Timestamp(0)
  updated_at  DateTime  @updatedAt @db.Timestamp(0)

  @@unique([email, purpose]) // m·ªói email/purpose 1 b·∫£n ghi ƒëang ho·∫°t ƒë·ªông
  @@map("email_otps")
  @@schema("clothing_ecom")
}

model site_contents {
  content_id Int      @id @default(autoincrement())
  slug       String   @unique @db.VarChar(255)
  title      String   @db.VarChar(500)
  content    String   @db.Text
  category   String   @db.VarChar(100)
  tags       String[] @default([])
  status     Boolean  @default(true)
  updated_by Int?
  created_at DateTime @default(now()) @db.Timestamp(0)
  updated_at DateTime @updatedAt @db.Timestamp(0)

  users users? @relation("UserUpdatedContents", fields: [updated_by], references: [user_id], onDelete: SetNull)

  @@index([slug])
  @@index([category])
  @@index([status])
  @@index([created_at])
  @@map("site_contents")
  @@schema("clothing_ecom")
}
